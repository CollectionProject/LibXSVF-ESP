<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"> 
    <title>ULX3S SD directory</title>
    <link rel="stylesheet" type="text/css" media="all" href="styles.css"/>
    <script type="text/javascript">
      // shorten typing: document.getElementById -> $id
      function $id(id) {
        return document.getElementById(id);
      }

      function load(e, t, n) {
            if ("js" == t) {
                var a = document.createElement("script");
                a.src = e,
                a.type = "text/javascript",
                a.async = !1,
                a.onload = function () { n() },
                document.getElementsByTagName("head")[0].appendChild(a)
            } else if ("css" == t) {
                var a = document.createElement("link");
                a.href = e,
                a.rel = "stylesheet",
                a.type = "text/css",
                a.async = !1,
                a.onload = function () { n() },
                document.getElementsByTagName("head")[0].appendChild(a)
            }
      }
      
      function path_for_new_folder(path)
      {
        var newfolder = document.getElementById("new_folder");
        newfolder.value = path;
        // move cursor to end and let last part of the path be shown
        //newfolder.selectionEnd = newfolder.value.length;
        //newfolder.selectionStart = newfolder.value.length;
      }

      function RemoveLastDirectoryPartOf(the_url)
      {
        var the_arr = the_url.split('/');
        the_arr.pop();
        return( the_arr.join('/') );
      }

      function append_row(name, file_type, current_path, idnum) {
              var full_path = "";
              if(name=="/") {
                full_path = "/";
              } else if (name==".") {
                full_path = current_path;
              } else if (name=="..") {
                full_path = RemoveLastDirectoryPartOf(current_path);
              } else {
              if(current_path=="/")
                full_path = "/"+name;
              else
                full_path = current_path+"/"+name;
              }
              var base_href = "/dir.htm?path="+full_path;
              var table = document.getElementById("directory_table");
              var tr = document.createElement("tr");
              var td1 = document.createElement("td");
              td1.id="name"+idnum;
              if(file_type == "file")
                var txt1 = document.createTextNode(name);
              else {
                var txt1 = document.createElement('a');
                var linkText = document.createTextNode(name);
                txt1.appendChild(linkText);
                txt1.href = base_href;
              }
              td1.appendChild(txt1);
              tr.appendChild(td1);
              var td2 = document.createElement("td");
              if(name != "/" && name != "." && name != "..") {
                var deleteText = document.createTextNode("\u274C"); // multiplication cross "x"
                var del_btn = document.createElement("button");
                del_btn.title = "DELETE"; // shows oh mouse hover
                del_btn.appendChild(deleteText);
                del_btn.onclick=function() { delete_button(idnum, file_type, full_path) };
                del_btn.id="delbtn"+idnum;
                td2.appendChild(del_btn);
              }
              tr.appendChild(td2);
              table.appendChild(tr);
      }

      // on successful delete, remove the file/dir name
      // and disable the delete button
      function delete_button(idnum, file_type, full_path) {
        var query_url = "";
        if(file_type == "file")
          query_url = "/rm?path="+full_path;
        else
          query_url = "/rmdir?path="+full_path;
	microAjax(query_url, function (res) { // lambda function
	  if(res == "success") {
            var obj_line = document.getElementById("name"+idnum); 
            obj_line.removeChild(obj_line.firstChild);
            var del_btn = document.getElementById("delbtn"+idnum); 
            del_btn.disabled="true"; // make button greyed out (disabled)
          }
	});
      }

      function clear_table() {
              var elmtTable = document.getElementById('directory_table');
              var tableRows = elmtTable.getElementsByTagName('tr');
              var rowCount = tableRows.length;
              for (var x=rowCount-1; x>0; x--) {
                elmtTable.removeChild(tableRows[x]);
              }
      }

      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
      
      // create directory and if successful, reload this web page
      function mkdir(input_id) {
        full_path = document.getElementById(input_id).value;
        var query_url = "/mkdir?path="+full_path;
	microAjax(query_url, function (res) { // lambda function
	  if(res == "success")
	    window.location.reload(true); 
	});
      }

      function directory_listing(url) // url parameter unused
      {
        var current_path = getParameterByName("path");
        if(!current_path)
          current_path="/";
        if(current_path=="")
          current_path="/";

        var new_folder_path = "/";
        if(current_path != "/") {
          new_folder_path = current_path+"/";
        }
	path_for_new_folder(new_folder_path);
        var query_url = "/dir?path="+current_path;
	microAjax(query_url, function (res) { // lambda function
                var objJSON = JSON.parse(res);
                // append_row("/", "dir", current_path);
                append_row(".", "dir", current_path);
                append_row("..", "dir", current_path);
                for(var i = 0; i < objJSON.files.length; i++) {
                  var file_type = "file";
                  if(i < objJSON.ndirs)
                    file_type = "dir";
                  append_row(objJSON.files[i], file_type, current_path, i);
                }
	});
      }
      
      window.onload = function ()
      {
            load("/styles.css", "css", function () {
                load("/microajax.js", "js", function () {
                    directory_listing("/dir");
                });
            });
            // refresh values every 5 seconds
            //setInterval(function() {
            //    directory_listing("/read");
            //}, 5000);
      }
    </script>
</head>
<body>
    <a href="index.htm">Home</a>
    <div class="row">
      <label for="Readings">ULX3S SD directory</label>
    </div>
    <div>
      <form method="post" enctype="multipart/form-data">
        <input name="myFile" type="file">
        <button>Save to SD</button>
      </form>
    </div>
    <div>
            <input type="text" name="path" value="/" id="new_folder"
                   onfocus="this.selectionStart = this.selectionEnd = this.value.length;"/>
            <button onclick="mkdir('new_folder')">New Folder</button>
    </div>
    <div>
      <table id="directory_table">
      </table>
    </div>
</body>
</html>
